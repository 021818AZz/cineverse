<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cadastro - Cineverse</title>

    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- CSS do sistema -->
    <link href="css/chunk-vendors.0468bd4c.css" rel="stylesheet">
    <link href="css/app.52d0b5178.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/305.e6860b9e.css">
    <link rel="stylesheet" type="text/css" href="css/88.dafac1e9.css">

    <style>
        .loginpage .section-box[data-v-ce999044]:after {
            position: absolute;
            content: "";
            width: 100vw;
            height: 100%;
            z-index: -1;
            left: 0;
            top: 0;
            background: url(img/imagesw.jpg) no-repeat top/100% auto, #000
        }
        .link-custom{
            color: #e21b15;
        }
        
        /* Estilos para Toastify customizados */
        .toastify {
            border-radius: 8px !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-weight: 600 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .toastify.toast-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        }
        
        .toastify.toast-error {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%) !important;
        }
        
        .toastify.toast-info {
            background: linear-gradient(135deg, #007bff 0%, #17a2b8 100%) !important;
        }
        
        .toastify.toast-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e21b15;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para o toggle de senha */
        .van-icon-eye-o::before {
            content: "üëÅÔ∏è";
        }
        
        .van-icon-closed-eye::before {
            content: "üëÅÔ∏è‚Äçüó®Ô∏è";
        }
        
        /* Estilo para c√≥digo de convite preenchido automaticamente */
        .invite-code-auto {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            color: #856404 !important;
        }
        
        /* Link de ajuda para c√≥digo de convite */
        .invite-help {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
            display: block;
        }
        
        /* Campo de telefone com c√≥digo integrado */
        .phone-input-container {
            display: flex;
            align-items: center;
        }
        
        .country-code {
            padding: 0 12px;
            background: #f5f5f5;
            border: 1px solid #ebedf0;
            border-right: none;
            border-radius: 4px 0 0 4px;
            height: 44px;
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #333;
        }
        
        .phone-input {
            flex: 1;
            border: 1px solid #ebedf0;
            border-left: none;
            border-radius: 0 4px 4px 0;
            height: 44px;
            padding: 0 12px;
            font-size: 16px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Criando sua conta...</p>
    </div>

    <form id="registerForm">
        <div id="app" data-v-app="">
            <div class="loginpage" data-v-ce999044="">
                <section class="section-box" data-v-ce999044="">
                    <img src="img/logo.png" alt="" class="truecol" data-v-ce999044="">
                    <p class="committ" data-v-ce999044=""> Junte-se √† Cineverse Angola e descubra um mundo de entretenimento exclusivo </p>
                    
                    <div class="wrap-content" data-v-ce999044="">
                        <div class="yourtoac" data-v-ce999044="">
                            <img src="img/internet.png" alt="" class="l-img" data-v-ce999044="">
                            <p data-v-ce999044="">Criar nova conta</p>
                        </div>
                        
                        <!-- Campo de telefone com +244 fixo -->
                        <div class="van-cell van-field input-box" data-v-ce999044="" style="padding: 0;">
                            <div class="van-field__left-icon" style="min-width: 70px;">
                                <p class="areacode" data-v-ce999044="" style="color: #333; font-weight: bold;">+244</p>
                            </div>
                            <div class="van-cell__value van-cell__value--alone van-field__value">
                                <div class="van-field__body">
                                    <input name="mobile" type="tel" inputmode="numeric" id="mobile" 
                                           class="van-field__control" placeholder="Digite seu n√∫mero de telefone:" 
                                           maxlength="9" style="padding-left: 0;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Senha -->
                        <div class="van-cell van-field input-box" data-v-ce999044="">
                            <div class="van-cell__value van-cell__value--alone van-field__value">
                                <div class="van-field__body">
                                    <input name="password" type="password" id="password" 
                                           class="van-field__control" placeholder="Crie uma senha (m√≠nimo 6 caracteres)">
                                    <div class="van-field__right-icon">
                                        <i class="van-badge__wrapper van-icon van-icon-closed-eye password-toggle" 
                                           data-v-ce999044="" style="cursor: pointer;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Confirmar Senha -->
                        <div class="van-cell van-field input-box" data-v-ce999044="">
                            <div class="van-cell__value van-cell__value--alone van-field__value">
                                <div class="van-field__body">
                                    <input name="confirmPassword" type="password" id="confirmPassword" 
                                           class="van-field__control" placeholder="Confirme sua senha">
                                </div>
                            </div>
                        </div>
                        
                        <!-- C√≥digo de convite (opcional) -->
                        <div class="van-cell van-field input-box" data-v-ce999044="">
                            <div class="van-cell__value van-cell__value--alone van-field__value">
                                <div class="van-field__body">
                                    <input name="inviteCode" type="text" id="inviteCode" 
                                           class="van-field__control" placeholder="C√≥digo de convite (opcional)">
                                </div>
                            </div>
                        </div>
                        <span class="invite-help" id="inviteCodeInfo" style="display: none;"></span>
                        
                        <!-- Bot√£o de cadastro -->
                        <button type="button" class="btnlog" id="submitBtn" data-v-ce999044="">Criar Conta</button>
                        
                        <!-- Link para login -->
                        <div class="haveanac" data-v-ce999044="" style="margin-top: 20px;">
                            <span onclick="window.location.href='index.html'" data-v-ce999044="" style="cursor: pointer;">
                                J√° tem uma conta? <span class="link-custom">Fa√ßa login</span>
                            </span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </form>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script>
        // Configura√ß√£o da API
        const API_BASE_URL = 'https://bd-p4q7.onrender.com';
        
        // Fun√ß√£o para extrair par√¢metros da URL (query string)
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Fun√ß√£o para extrair c√≥digo de convite do pathname
        function extractCodeFromPathname() {
            const pathname = window.location.pathname;
            
            // Verificar se o pathname cont√©m um c√≥digo (ex: /register/ABC123)
            const pathParts = pathname.split('/').filter(part => part.trim() !== '');
            
            // Se o √∫ltimo segmento do path for um c√≥digo (n√£o √© "register" e tem pelo menos 3 caracteres)
            if (pathParts.length > 0) {
                const lastPart = pathParts[pathParts.length - 1];
                // Verificar se parece ser um c√≥digo (n√£o √© uma extens√£o de arquivo, tem 3+ caracteres)
                if (lastPart.length >= 3 && !lastPart.includes('.') && 
                    lastPart !== 'register' && lastPart !== 'index.html' && 
                    lastPart !== 'cadastro.html' && lastPart !== 'index.html') {
                    return lastPart;
                }
            }
            
            return '';
        }
        
        // Fun√ß√£o para extrair c√≥digo de convite do hash (#)
        function extractCodeFromHash() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#')) {
                const code = hash.substring(1);
                // Verificar se o hash parece ser um c√≥digo (m√≠nimo 3 caracteres)
                if (code.length >= 3 && !code.includes('/') && !code.includes('?')) {
                    return code;
                }
            }
            return '';
        }
        
        // Fun√ß√£o para extrair c√≥digo de convite da URL completa
        function extractInviteCodeFromUrl() {
            // 1. Tentar obter do par√¢metro de query 'ref'
            const queryCode = getUrlParameter('ref');
            if (queryCode && queryCode.trim() !== '') {
                return queryCode.trim();
            }
            
            // 2. Tentar obter do par√¢metro de query 'code'
            const queryCodeAlt = getUrlParameter('code');
            if (queryCodeAlt && queryCodeAlt.trim() !== '') {
                return queryCodeAlt.trim();
            }
            
            // 3. Tentar obter do par√¢metro de query 'invite'
            const queryInvite = getUrlParameter('invite');
            if (queryInvite && queryInvite.trim() !== '') {
                return queryInvite.trim();
            }
            
            // 4. Tentar extrair do pathname (ex: /register/CODE123)
            const pathCode = extractCodeFromPathname();
            if (pathCode && pathCode.trim() !== '') {
                return pathCode.trim();
            }
            
            // 5. Tentar extrair do hash (ex: #CODE123)
            const hashCode = extractCodeFromHash();
            if (hashCode && hashCode.trim() !== '') {
                return hashCode.trim();
            }
            
            return '';
        }
        
        // Fun√ß√£o para preencher automaticamente o c√≥digo de convite
        function autoFillInviteCode() {
            const inviteCode = extractInviteCodeFromUrl();
            
            if (inviteCode && inviteCode.trim() !== '') {
                const inviteCodeInput = document.getElementById('inviteCode');
                const inviteCodeInfo = document.getElementById('inviteCodeInfo');
                
                // Preencher o campo com o c√≥digo extra√≠do
                inviteCodeInput.value = inviteCode;
                
                // Adicionar classe de estilo para indicar preenchimento autom√°tico
                inviteCodeInput.classList.add('invite-code-auto');
                
                // Mostrar informa√ß√£o sobre o c√≥digo preenchido automaticamente
                inviteCodeInfo.textContent = `‚úì C√≥digo de convite preenchido automaticamente: ${inviteCode}`;
                inviteCodeInfo.style.display = 'block';
                inviteCodeInfo.style.color = '#28a745';
                
                console.log('C√≥digo de convite preenchido automaticamente:', inviteCode);
                console.log('URL completa:', window.location.href);
                
                // Mostrar um toast informando o c√≥digo preenchido
                showToast(`C√≥digo de convite "${inviteCode}" preenchido automaticamente!`, 'info');
            }
        }
        
        // Fun√ß√£o para mostrar toast usando Toastify
        function showToast(message, type = 'info') {
            // Configura√ß√µes do Toastify
            const config = {
                text: message,
                duration: 3000,
                gravity: "top",
                position: "center",
                stopOnFocus: true,
                className: `toast-${type}`,
                style: {
                    background: type === 'success' ? "linear-gradient(135deg, #28a745 0%, #20c997 100%)" :
                               type === 'error' ? "linear-gradient(135deg, #dc3545 0%, #fd7e14 100%)" :
                               type === 'warning' ? "linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)" :
                               "linear-gradient(135deg, #007bff 0%, #17a2b8 100%)"
                }
            };
            
            Toastify(config).showToast();
        }
        
        // Fun√ß√£o para mostrar/ocultar loading
        function showLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const submitBtn = document.getElementById('submitBtn');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processando...';
            }
        }
        
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const submitBtn = document.getElementById('submitBtn');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Criar Conta';
            }
        }
        
        // Fun√ß√£o para validar n√∫mero de telefone de Angola
        function validateAngolanPhone(phone) {
            // Remove qualquer caractere n√£o num√©rico
            const cleanNumber = phone.replace(/\D/g, '');
            
            // Verifica se tem exatamente 9 d√≠gitos
            if (cleanNumber.length !== 9) {
                return {
                    valid: false,
                    message: 'O n√∫mero deve ter exatamente 9 d√≠gitos'
                };
            }
            
            // Verifica se come√ßa com 9
            if (!cleanNumber.startsWith('9')) {
                return {
                    valid: false,
                    message: 'N√∫mero angolano deve come√ßar com 9'
                };
            }
            
            // Verifica se o segundo d√≠gito √© v√°lido (1-9)
            const secondDigit = parseInt(cleanNumber.charAt(1));
            if (secondDigit < 1 || secondDigit > 9) {
                return {
                    valid: false,
                    message: 'N√∫mero inv√°lido'
                };
            }
            
            return {
                valid: true,
                cleanNumber: cleanNumber
            };
        }
        
        // Fun√ß√£o para formatar n√∫mero para o banco de dados
        function formatPhoneForDatabase(phone) {
            const validation = validateAngolanPhone(phone);
            if (!validation.valid) {
                return null;
            }
            
            // Adiciona c√≥digo do pa√≠s 244 na frente: 244 + 9 d√≠gitos = 12 d√≠gitos
            return '244' + validation.cleanNumber;
        }
        
        // Fun√ß√£o para alternar visibilidade da senha
        function setupPasswordToggle() {
            const passwordToggle = document.querySelector('.password-toggle');
            const passwordInput = document.getElementById('password');
            
            if (passwordToggle && passwordInput) {
                passwordToggle.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.classList.remove('van-icon-closed-eye');
                        this.classList.add('van-icon-eye-o');
                    } else {
                        passwordInput.type = 'password';
                        this.classList.remove('van-icon-eye-o');
                        this.classList.add('van-icon-closed-eye');
                    }
                });
            }
        }
        
        // Fun√ß√£o principal de registro
        async function performRegister(mobile, password, inviteCode) {
            // Formatar o n√∫mero para o banco de dados
            const fullPhoneForDB = formatPhoneForDatabase(mobile);
            
            if (!fullPhoneForDB) {
                showToast('N√∫mero de telefone inv√°lido', 'error');
                hideLoading();
                return;
            }
            
            try {
                console.log('Enviando dados para registro:', {
                    mobile: fullPhoneForDB,
                    password_length: password.length,
                    invite_code: inviteCode || 'N√£o informado'
                });
                
                // Preparar dados para envio
                const registerData = {
                    mobile: fullPhoneForDB,
                    password: password
                };
                
                // Adicionar c√≥digo de convite se fornecido
                if (inviteCode && inviteCode.trim() !== '') {
                    registerData.invitation_code = inviteCode.trim();
                }
                
                // Fazer requisi√ß√£o para a API de registro
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });
                
                const data = await response.json();
                console.log('Resposta da API:', data);
                
                if (data.success) {
                    hideLoading();
                    showToast('Conta criada com sucesso!', 'success');
                    
                    // Redirecionar para p√°gina de login ap√≥s 2 segundos
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 2000);
                    
                } else {
                    hideLoading();
                    showToast(data.message || 'Erro ao criar conta', 'error');
                }
                
            } catch (error) {
                console.error('Erro no registro:', error);
                hideLoading();
                showToast('Erro de conex√£o com o servidor', 'error');
            }
        }
        
        // Fun√ß√£o para lidar com o clique no bot√£o de cadastro
        function handleRegister() {
            // Obter valores dos campos
            const mobile = document.getElementById('mobile').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const inviteCode = document.getElementById('inviteCode').value.trim();
            
            console.log('Validando cadastro:', {
                mobile: mobile.substring(0, 3) + '...',
                password_length: password.length,
                invite_code: inviteCode || 'N√£o informado'
            });
            
            // Valida√ß√µes
            if (!mobile) {
                showToast('Digite o n√∫mero de telefone...', 'error');
                document.getElementById('mobile').focus();
                return;
            }
            
            const phoneValidation = validateAngolanPhone(mobile);
            if (!phoneValidation.valid) {
                showToast('N√∫mero inv√°lido. Digite 9 d√≠gitos come√ßando com 9. Exemplo: 912345678', 'error');
                document.getElementById('mobile').focus();
                return;
            }
            
            if (!password) {
                showToast('Digite uma senha...', 'error');
                document.getElementById('password').focus();
                return;
            }
            
            if (password.length < 6) {
                showToast('A senha deve ter pelo menos 6 caracteres', 'error');
                document.getElementById('password').focus();
                return;
            }
            
            if (!confirmPassword) {
                showToast('Confirme sua senha...', 'error');
                document.getElementById('confirmPassword').focus();
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('As senhas n√£o coincidem', 'error');
                document.getElementById('confirmPassword').focus();
                return;
            }
            
            // Mostrar loading e processar registro
            showLoading();
            performRegister(mobile, password, inviteCode);
        }
        
        // Fun√ß√£o para formatar o telefone enquanto digita
        function setupPhoneFormatting() {
            const phoneInput = document.getElementById('mobile');
            
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    // Remove qualquer caractere n√£o num√©rico
                    let value = this.value.replace(/\D/g, '');
                    
                    // Limita a 9 d√≠gitos
                    if (value.length > 9) {
                        value = value.substring(0, 9);
                    }
                    
                    // Atualiza o valor
                    this.value = value;
                    
                    // Se come√ßar com 9, mostra dica
                    if (value.length > 0 && !value.startsWith('9')) {
                        this.style.borderColor = '#dc3545';
                    } else {
                        this.style.borderColor = '';
                    }
                });
                
                // Dica quando o campo recebe foco
                phoneInput.addEventListener('focus', function() {
                    if (!this.value) {
                        this.placeholder = '912345678';
                    }
                });
                
                phoneInput.addEventListener('blur', function() {
                    this.placeholder = '9XXXXXXXX';
                });
            }
        }
        
        // Fun√ß√£o para alternar visibilidade da confirma√ß√£o de senha
        function setupConfirmPasswordToggle() {
            // Podemos adicionar um √≠cone para mostrar/ocultar a confirma√ß√£o tamb√©m
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // Criar √≠cone manualmente se quiser
            // Por enquanto, apenas o campo b√°sico
        }
        
        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando sistema de cadastro...');
            console.log('URL atual:', window.location.href);
            
            // 1. Preencher automaticamente c√≥digo de convite se estiver na URL
            autoFillInviteCode();
            
            // 2. Configurar formata√ß√£o do telefone
            setupPhoneFormatting();
            
            // 3. Configurar toggle da senha
            setupPasswordToggle();
            
            // 4. Adicionar evento ao bot√£o de cadastro
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', handleRegister);
                console.log('Bot√£o de cadastro configurado');
            }
            
            // 5. Permitir submit com Enter nos campos
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleRegister();
                    }
                });
            });
            
            console.log('Sistema de cadastro inicializado com sucesso!');
        });
        
        // Fun√ß√£o global para cadastro (para compatibilidade)
        window.register = function() {
            handleRegister();
        };
        
        // Exportar fun√ß√µes para uso global
        window.registerApp = {
            handleRegister,
            validatePhone: validateAngolanPhone,
            formatPhone: formatPhoneForDatabase,
            extractInviteCode: extractInviteCodeFromUrl
        };
    </script>
</body>
</html>