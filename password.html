<html lang="pt-AO">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="icon" href="/cineverse/dist/favicon.ico">
    <title>Cineverse - Alterar Senha</title>
    
    <link href="css/chunk-vendors.0468bd4c.css" rel="stylesheet">
    <link href="css/app.52d0b517.css" rel="stylesheet">
    
    <link rel="stylesheet" type="text/css" href="css/580.66923993.css">
    <link rel="stylesheet" type="text/css" href="css/437.66264f7a.css">
    <link rel="stylesheet" type="text/css" href="css/165.444cee7e.css">
    <link rel="stylesheet" type="text/css" href="css/868.ef352a45.css">
    <link rel="stylesheet" type="text/css" href="css/67.9404612c.css">
    <link rel="stylesheet" type="text/css" href="css/123.32f7ffba.css">
    <link rel="stylesheet" type="text/css" href="css/589.f9f3d6c5.css">
    
    <style>
        /* Estilos para toast */
        .custom-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .toast-success {
            background-color: #4CAF50;
        }
        
        .toast-error {
            background-color: #f44336;
        }
        
        .toast-info {
            background-color: #2196F3;
        }
        
        .toast-warning {
            background-color: #ff9800;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* Estilo para loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para inputs e botões */
        .input-box input {
            color: #333 !important;
        }
        
        .btnsit {
            background: linear-gradient(45deg, #FF5722, #FF9800);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .btnsit:hover {
            background: linear-gradient(45deg, #E64A19, #F57C00);
            transform: translateY(-2px);
        }
        
        .btnsit:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-error {
            border: 2px solid #f44336 !important;
        }
        
        .input-success {
            border: 2px solid #4CAF50 !important;
        }
    </style>
</head>
<body>
    <div id="app" data-v-app="" bis_skin_checked="1">
        <div class="passpage" data-v-3b6cbbd1="" bis_skin_checked="1">
            <div class="van-nav-bar van-hairline--bottom navboxi" data-v-3b6cbbd1="" bis_skin_checked="1">
                <div class="van-nav-bar__content" bis_skin_checked="1">
                    <div class="van-nav-bar__left van-haptics-feedback" bis_skin_checked="1" onclick="window.location.href='/profile.html'">
                        <i class="van-badge__wrapper van-icon van-icon-arrow-left van-nav-bar__arrow"></i>
                    </div>
                    <div class="van-nav-bar__title van-ellipsis" bis_skin_checked="1">Alterar senha</div>
                </div>
            </div>
            
            <img src="img/senha.png" alt="Ícone de Senha" class="pas-img" data-v-3b6cbbd1="">
            
            <section class="section-box" data-v-3b6cbbd1="">
                <div class="van-tabs van-tabs--line tabs-box" data-v-3b6cbbd1="" bis_skin_checked="1">
                    <div class="van-tabs__wrap" bis_skin_checked="1">
                        <div role="tablist" class="van-tabs__nav van-tabs__nav--line van-tabs__nav--complete" 
                            aria-orientation="horizontal" bis_skin_checked="1">
                            <div id="van-tabs-6-0" role="tab"
                                class="van-tab van-tab--line van-tab--grow van-tab--active" tabindex="0" 
                                aria-selected="true" aria-controls="van-tab-7" bis_skin_checked="1">
                                <span class="van-tab__text"><p data-v-3b6cbbd1="">Senha de login</p></span>
                            </div>
                            <div id="van-tabs-6-1" role="tab" class="van-tab van-tab--line van-tab--grow" tabindex="-1" onclick="window.location.href='/tpassword.html'"
                                aria-selected="false" aria-controls="van-tab-8" bis_skin_checked="1">
                                <span class="van-tab__text"><p data-v-3b6cbbd1="">Senha de retirada</p></span>
                            </div>
                            <div class="van-tabs__line" style="transform: translateX(88px) translateX(-50%);"
                                bis_skin_checked="1"></div>
                        </div>
                    </div>
                    
                    <div class="van-tabs__content" bis_skin_checked="1">
                        <div id="van-tab-7" role="tabpanel" class="van-tab__panel" tabindex="0"
                            aria-labelledby="van-tabs-6-0" data-v-3b6cbbd1="" style="" bis_skin_checked="1">
                            
                            <p class="tinameps" data-v-3b6cbbd1="">Senha original</p>
                            <div class="van-cell van-field input-box" data-v-3b6cbbd1="" bis_skin_checked="1">
                                <div class="van-cell__value van-cell__value--alone van-field__value" bis_skin_checked="1">
                                    <div class="van-field__body" bis_skin_checked="1">
                                        <input type="password" id="currentPassword" class="van-field__control password-input" placeholder="Digite a senha de login original">
                                        <div class="van-field__right-icon" bis_skin_checked="1">
                                            <i class="van-badge__wrapper van-icon van-icon-closed-eye icony toggle-password" data-v-3b6cbbd1=""></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p class="tinameps" data-v-3b6cbbd1="">Nova senha</p>
                            <div class="van-cell van-field input-box" data-v-3b6cbbd1="" bis_skin_checked="1">
                                <div class="van-cell__value van-cell__value--alone van-field__value" bis_skin_checked="1">
                                    <div class="van-field__body" bis_skin_checked="1">
                                        <input type="password" id="newPassword" class="van-field__control password-input" placeholder="Digite a nova senha de login">
                                        <div class="van-field__right-icon" bis_skin_checked="1">
                                            <i class="van-badge__wrapper van-icon van-icon-closed-eye icony toggle-password" data-v-3b6cbbd1=""></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p class="tinameps" data-v-3b6cbbd1="">Confirmar senha</p>
                            <div class="van-cell van-field input-box" data-v-3b6cbbd1="" bis_skin_checked="1">
                                <div class="van-cell__value van-cell__value--alone van-field__value" bis_skin_checked="1">
                                    <div class="van-field__body" bis_skin_checked="1">
                                        <input type="password" id="confirmPassword" class="van-field__control password-input" placeholder="Confirme a nova senha">
                                        <div class="van-field__right-icon" bis_skin_checked="1">
                                            <i class="van-badge__wrapper van-icon van-icon-closed-eye icony toggle-password" data-v-3b6cbbd1=""></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button id="changePasswordBtn" class="btnsit" data-v-3b6cbbd1">Alterar 》</button>
                        </div>

                        <div id="van-tab-8" role="tabpanel" class="van-tab__panel" tabindex="-1"
                            aria-labelledby="van-tabs-6-1" data-v-3b6cbbd1="" style="display: none;"
                            bis_skin_checked="1">
                        </div>
                    </div>
                </div>
                
                <p class="encounter" data-v-3b6cbbd1=""> 
                    <strong>Aviso:</strong><br data-v-3b6cbbd1=""> 
                    Se sua senha vazar, altere-a imediatamente para proteger a segurança dos fundos da sua conta.
                </p>
            </section>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
    // Configuração da API
    const API_BASE_URL = 'https://bd-p4q7.onrender.com';

    // Função para mostrar/ocultar loading
    function showLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }

    // Função para mostrar toast
    function showToast(message, type = 'info') {
        // Remove toast anterior se existir
        const existingToast = document.querySelector('.custom-toast');
        if (existingToast) {
            existingToast.remove();
        }
        
        // Cria novo toast
        const toast = document.createElement('div');
        toast.className = `custom-toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        // Remove o toast após 3 segundos
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    }

    // Função para verificar se o token é válido
    function isTokenValid() {
        const tokenData = localStorage.getItem('user_token');
        
        if (!tokenData) return false;
        
        try {
            const { expiry } = JSON.parse(tokenData);
            if (Date.now() > expiry) {
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_id');
                return false;
            }
            return true;
        } catch (e) {
            console.error('Erro ao verificar token:', e);
            return false;
        }
    }

    // Função para obter o token do localStorage
    function getAuthToken() {
        const tokenData = localStorage.getItem('user_token');
        if (!tokenData) return null;
        
        try {
            const { token } = JSON.parse(tokenData);
            return token;
        } catch (e) {
            console.error('Erro ao obter token:', e);
            return null;
        }
    }

    // Função para alternar visibilidade da senha
    function setupPasswordToggles() {
        const toggleIcons = document.querySelectorAll('.toggle-password');
        
        toggleIcons.forEach(icon => {
            icon.addEventListener('click', function() {
                const input = this.closest('.van-field__body').querySelector('input');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    this.classList.remove('van-icon-closed-eye');
                    this.classList.add('van-icon-eye-o');
                } else {
                    input.type = 'password';
                    this.classList.remove('van-icon-eye-o');
                    this.classList.add('van-icon-closed-eye');
                }
            });
        });
    }

    // Função para validar senha
    function validatePassword(password) {
        if (!password || password.length < 6) {
            return { valid: false, message: 'A senha deve ter pelo menos 6 caracteres' };
        }
        
        // Verificar se tem pelo menos um número
        if (!/\d/.test(password)) {
            return { valid: false, message: 'A senha deve conter pelo menos um número' };
        }
        
        // Verificar se tem pelo menos uma letra
        if (!/[a-zA-Z]/.test(password)) {
            return { valid: false, message: 'A senha deve conter pelo menos uma letra' };
        }
        
        return { valid: true, message: 'Senha válida' };
    }

    // Função principal para alterar senha
    async function handlePasswordChange() {
        // Obter valores dos campos
        const currentPassword = document.getElementById('currentPassword').value.trim();
        const newPassword = document.getElementById('newPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();
        
        // Validações básicas
        if (!currentPassword) {
            showToast('Digite a senha atual', 'error');
            document.getElementById('currentPassword').focus();
            return false;
        }
        
        if (!newPassword) {
            showToast('Digite a nova senha', 'error');
            document.getElementById('newPassword').focus();
            return false;
        }
        
        if (!confirmPassword) {
            showToast('Confirme a nova senha', 'error');
            document.getElementById('confirmPassword').focus();
            return false;
        }
        
        // Validar nova senha
        const passwordValidation = validatePassword(newPassword);
        if (!passwordValidation.valid) {
            showToast(passwordValidation.message, 'error');
            document.getElementById('newPassword').focus();
            return false;
        }
        
        // Verificar se as senhas coincidem
        if (newPassword !== confirmPassword) {
            showToast('As senhas não coincidem', 'error');
            document.getElementById('confirmPassword').focus();
            return false;
        }
        
        // Verificar se a nova senha é diferente da atual
        if (newPassword === currentPassword) {
            showToast('A nova senha deve ser diferente da atual', 'warning');
            return false;
        }
        
        // Verificar autenticação
        const token = getAuthToken();
        if (!token || !isTokenValid()) {
            showToast('Sessão expirada. Faça login novamente.', 'error');
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 2000);
            return false;
        }
        
        try {
            showLoading();
            
            // Desabilitar botão durante a requisição
            const changeBtn = document.getElementById('changePasswordBtn');
            changeBtn.disabled = true;
            changeBtn.textContent = 'Alterando...';
            
            console.log('Enviando requisição para alterar senha...');
            
            // Fazer requisição para a API
            const response = await fetch(`${API_BASE_URL}/user/password/update`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });
            
            const data = await response.json();
            console.log('Resposta da API:', data);
            
            if (data.success) {
                showToast('Senha alterada com sucesso!', 'success');
                
                // Limpar campos
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Redirecionar para perfil após 2 segundos
                setTimeout(() => {
                    window.location.href = '/profile.html';
                }, 2000);
                
                return true;
            } else {
                showToast(data.message || 'Erro ao alterar senha', 'error');
                return false;
            }
            
        } catch (error) {
            console.error('Erro ao alterar senha:', error);
            showToast('Erro de conexão com o servidor', 'error');
            return false;
        } finally {
            hideLoading();
            
            // Reabilitar botão
            const changeBtn = document.getElementById('changePasswordBtn');
            changeBtn.disabled = false;
            changeBtn.textContent = 'Alterar 》';
        }
    }

    // Função para configurar validações em tempo real
    function setupRealTimeValidation() {
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        
        // Validação da nova senha
        if (newPasswordInput) {
            newPasswordInput.addEventListener('blur', function() {
                const password = this.value.trim();
                if (password) {
                    const validation = validatePassword(password);
                    if (!validation.valid) {
                        this.classList.add('input-error');
                        this.classList.remove('input-success');
                    } else {
                        this.classList.remove('input-error');
                        this.classList.add('input-success');
                    }
                }
            });
            
            newPasswordInput.addEventListener('input', function() {
                const password = this.value.trim();
                if (password) {
                    // Remove classes de validação durante a digitação
                    this.classList.remove('input-error', 'input-success');
                }
            });
        }
        
        // Validação de correspondência de senhas
        if (confirmPasswordInput && newPasswordInput) {
            confirmPasswordInput.addEventListener('input', function() {
                const newPass = newPasswordInput.value.trim();
                const confirmPass = this.value.trim();
                
                if (confirmPass) {
                    if (newPass && newPass !== confirmPass) {
                        this.classList.add('input-error');
                        this.classList.remove('input-success');
                    } else if (newPass && newPass === confirmPass) {
                        this.classList.remove('input-error');
                        this.classList.add('input-success');
                    }
                }
            });
        }
    }

    // Inicializar quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Página de alteração de senha carregada');
        
        // Verificar se o usuário está autenticado
        if (!isTokenValid()) {
            showToast('Sessão expirada. Faça login novamente.', 'error');
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 2000);
            return;
        }
        
        // Configurar toggle de visibilidade da senha
        setupPasswordToggles();
        
        // Configurar validação em tempo real
        setupRealTimeValidation();
        
        // Adicionar evento ao botão de alterar senha
        const changeBtn = document.getElementById('changePasswordBtn');
        if (changeBtn) {
            changeBtn.addEventListener('click', handlePasswordChange);
        }
        
        // Permitir submit com Enter em qualquer campo
        const passwordInputs = document.querySelectorAll('.password-input');
        passwordInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handlePasswordChange();
                }
            });
        });
    });

    // Exportar função para uso global (APENAS PARA CHAMADAS EXTERNAS)
    window.changePassword = function() {
        return handlePasswordChange();
    };
    </script>
</body>
</html>